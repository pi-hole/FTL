From d7ae8bb3e61ec2d9b147c0f081fb83a459a9e938 Mon Sep 17 00:00:00 2001
From: williamvds <william@williamvds.me>
Date: Sun, 15 Jun 2025 21:11:30 +0100
Subject: [PATCH] Forward connection socket paths to mg_request_info

Signed-off-by: averyv <avery@averyv.me>
---
 src/webserver/civetweb/civetweb.c | 12 ++++++++++++
 src/webserver/civetweb/civetweb.h |  1 +
 2 files changed, 13 insertions(+)

diff --git a/src/webserver/civetweb/civetweb.c b/src/webserver/civetweb/civetweb.c
index 08238ead..688730c0 100644
--- a/src/webserver/civetweb/civetweb.c
+++ b/src/webserver/civetweb/civetweb.c
@@ -20353,6 +20353,12 @@ worker_thread_run(struct mg_connection *conn)
 		conn->request_info.server_port =
 		    ntohs(USA_IN_PORT_UNSAFE(&conn->client.lsa));
 
+#if defined(USE_X_DOM_SOCKET)
+		if (conn->client.lsa.sa.sa_family == AF_UNIX) {
+			conn->request_info.socket_path = conn->client.lsa.sun.sun_path;
+		}
+#endif
+
 		sockaddr_to_string(conn->request_info.remote_addr,
 		                   sizeof(conn->request_info.remote_addr),
 		                   &conn->client.rsa);
@@ -20566,6 +20572,12 @@ accept_new_connection(const struct socket *listener, struct mg_context *ctx)
 			                    strerror(ERRNO));
 		}
 
+#if defined(USE_X_DOM_SOCKET)
+		if (so.lsa.sa.sa_family == AF_UNIX) {
+			mg_strlcpy(so.lsa.sun.sun_path, listener->lsa.sun.sun_path, sizeof(so.lsa.sun.sun_path));
+		}
+#endif
+
 #if !defined(__ZEPHYR__)
 		if ((so.lsa.sa.sa_family == AF_INET)
 		    || (so.lsa.sa.sa_family == AF_INET6)) {
diff --git a/src/webserver/civetweb/civetweb.h b/src/webserver/civetweb/civetweb.h
index ba307862..075f3225 100644
--- a/src/webserver/civetweb/civetweb.h
+++ b/src/webserver/civetweb/civetweb.h
@@ -188,6 +188,7 @@ struct mg_request_info {
 	/* Pi-hole modification */
 	char csrf_token[32];
 	int is_authenticated;
+	const char *socket_path; /* Unix socket file path */
 };
 
 
-- 
2.49.0

